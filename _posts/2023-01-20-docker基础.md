---
layout: post   	
catalog: true 	
tags:
    - Docker
---





## Docker 是什么

Docker允许开发中将应用、依赖、函数库、配置一起打包，形成可移植镜像

Docker应用运行在容器中， 使用沙箱机制，相互隔离

Docker镜像中包含完整运行环境， 包括系统函数库，仅依赖系统的Linux内核，因此可以在任意Linux操作系统上运行

## Docker与虚拟机

Docker和虚拟机都是基于软件的平台虚拟化技术

虚拟机属于完全虚拟化，即模拟完整的底层硬件环境特权指令的执行，客户操
作系统无需进行修改。比如我们常用的VirtualBox，VMWare Workstation和
Parallels Desktop等虚拟化软件。

Docker容器技术是操作系统级虚拟化，即直接通过内核创建虚拟的操作系统实例(内核和库)，来隔离不同的进程和资源，多个容器可以在同一台机器上运
行，共享操作系统内核，但各自作为独立的进程在用户空间中运行。

Docker容器不需要额外的虚拟机管理软件和虚拟机操作系统层，直接在宿主机操作系统层面上实现虚拟化，从而达到轻量级，高效的目的。

## Docker 组成

### 镜像

Docker把应用程序及其依赖，打包在image文件里面。只有通过这个文件，才能生成Docker容器。
image文件可以看作是容器的模板，除了提供容器运行时所需的程序、库、资
源、配置等文件外，还包含了一些为运行时准备的一些配置参数(如匿名卷、
环境变量、用户等)
Docker根据image文件生成容器的实例。同一个image文件，可以生成多
个同时运行的容器实例。

### 容器

容器是镜像运行的实体，每个软件运行环境都是独立的、隔离的，称之为容器

### 仓库

通常，一个仓库会包含同一个软件不同版本的镜像，而标签就常用于对应该软
件的各个版本。我们可以通过<仓库名>:<标签>的格式来指定具体是这个软
件哪个版本的镜像。如果不给出标签，将以latest 作为默认标签。

## Docker架构

### 客户端(client)

通过命令或RestAPI向Docker服务端发送指令。可以在本地或远程向服务端发送指令。

### 服务端(server):

Docker守护进程， 负责处理Docker指令，管理镜像、容器等

## Docker 镜像操作

```
访问DockerHub搜索镜像，https://hub.docker.com/

拉取镜像：docker pull redis

查看本地镜像：docker images

将镜像导出到磁盘：docker save -o 文件名称 镜像名称/ID

删除本地镜像：docker rmi 镜像名称/ID

导入镜像：docker load -i 文件名称

修改镜像源 "registry-mirrors":["https://mirror.ccs.tencentyun.com"]
```

## Docker 容器操作

```
docker run 新建并启动容器
docker start/stop/ pause/unpause 启动/停止/暂停/恢复容器
docker exec 进入容器执行命令
docker logs 查看容器运行日志
docker ps 查看容器的状态
docker rm 删除指定容器
```

例：安装ngnix

```
拉取nginx镜像docker pull nginx
创建并启动容器docker run --name mynginx -d -p 80:80 nginx
--name:指定容器名称
-p:将宿主机端口与容器端口映射，格式:宿主机端口:容器端口
-d:后台运行容器
```

例：安装redis

```
拉取redis镜像docker pull redis
创建并启动容器docker run --name myredis -d -p 6379:6379 redis
进入容器: docker exec -it myredis bash
-it:给当前进入的容器创建一个标准输入、 输出终端，允许我们与容器交互
bash:进入容器后执行的命令
进入容器后执行: redis-cli, 使用redis客户端操作redis
```

## Docker 数据卷

一个容器运行了一-段时间，肯定会产生一些数据，比如日志、数据库数据、新
改的配置文件等等，如果这些数据文件存放在容器中，当我们删除容器时，这
些数据也会被随之删除。
在docker中，提供了一种存储数据的方法，叫做“数据卷”， 可以达到数据共
享的目的。

### 数据卷特性

数据卷可以在容器之间共享和重用，容器间传递数据将变得高效与方便

对数据卷内数据的修改会立马生效，无论是容器内操作还是本地操作

对数据卷的更新不会影响镜像，解耦开应用和数据

卷会一直存在， 直到没有容器使用，可以安全地卸载它

### 数据卷操作命令

数据卷操作的基本语法为：docker volume [COMMAND]，其中COMMAND可
选值。

```
create：创建一个volume
inspect：显示一个或多 个volume的信息
ls：列出所有的volume
prune：删除未使用的volume
rm：删除一个或多个指定的volume

在linux的docker主机中创建一个卷时， 其在宿主机对应的目录(挂载点)路径为/var/lib/docker/volumes/卷名/_ data
```

### 挂载卷

将数据卷和容器目录建立映射

```
在创建容器时，可以通过--volume或 -V参数挂载一个数据卷到某 个容器目录
docker run --name testAcon -V testA:/data -d redis
上述命令表示创建一 个名为testAcon的容器，将testA卷映射到testAcon容器的/data目录中
注意:如果卷映射的目录在容器中不存在时，会自动在容器中创建对应的目录
一个容器可以使用多个卷，只需要多次使用-v选项指定即可
docker run --name testBcon -V testA:/data -V testB:/var/log -d redis
当指定的卷不存在时，docker会自动创建对应的卷，上述命令 中的testB数据卷会被自动创建
```

### 绑定挂载

将宿主机的任意目录或文件和容器目录或文件建立映射

```
前面创建的数据卷都存放在/var/lib/docker/volumes目录中，这个目录是固定的，它们都能被docker volume命令管理。
docker还有一种映射宿主机目录的方法，这种方法被称之为”绑定挂载”,绑定
挂载能够将指定的宿主机目录挂载到容器中，只需要将卷名替换成宿主机上的目录路径即可
docker run -d --name testAcon -V /root/test1:/data1 redis
上述命令将宿主机的/root/test1目录映射到容器的/data1目录中
绑定挂载不会生成任何卷，它直接将指定的宿主机目录映射到容器中，所以，
docker volume命令无法查看或管理到绑定挂载的路径
```

## 自定义镜像

某些情况下我们要自己构建镜像

比如：找不到现成的镜像，比如自己开发的应用程序。需要在镜像中加入特定的功能。

### 编写 Dockerfile

```
FROM node:11
MAINTAINER easydoc.net
# 复制代码
ADD . /app
# 设置容器启动后的默认运行目录
WORKDIR /app

# 运行命令，安装依赖
# RUN 命令可以有多个，但是可以用 && 连接多个命令来减少层级。
# 例如 RUN npm install && cd /app && mkdir logs
RUN npm install --registry=https://registry.npm.taobao.org

# CMD 指令只能一个，是容器启动后执行的命令，算是程序的入口。
# 如果还需要运行其他命令可以用 && 连接，也可以写成一个shell脚本去执行。
# 例如 CMD cd /app && ./start.sh
CMD node app.js
```

## 多容器通信

### 创建虚拟网络

要想多容器之间互通，从 Web 容器访问 Redis 容器，我们只需要把他们放到同个网络中就可以了

### 演示

创建一个名为`test-net`的网络：

```
docker network create test-net
```

运行 Redis 在 `test-net` 网络中，别名`redis`

```
docker run -d --name redis --network test-net --network-alias redis redis:latest
```

修改代码中访问`redis`的地址为网络别名

运行 Web 项目，使用同个网络

```
docker run -p 8080:8080 --name test -v D:/test:/app --network test-net -d test:v1
```

查看数据

`http://localhost:8080/redis`
容器终端查看数据是否一致

### 相关命令

`docker network ls` 查看网络列表

## Docker-Compose

使用 docker-compose 把项目的多个服务集合到一起，一键运行。

### 安装 Docker Compose

- 如果你是安装的桌面版 Docker，不需要额外安装，已经包含了。
- 如果是没图形界面的服务器版 Docker，你需要单独安装 [安装文档](https://docs.docker.com/compose/install/#install-compose-on-linux-systems)
- 运行`docker-compose`检查是否安装成功

### 编写脚本

要把项目依赖的多个服务集合到一起，我们需要编写一个`docker-compose.yml`文件，描述依赖哪些服务
参考文档：https://docs.docker.com/compose/

```
version: "3.7"

services:
  app:
    build: ./
    ports:
      - 80:8080
    volumes:
      - ./:/app
    environment:
      - TZ=Asia/Shanghai
  redis:
    image: redis:5.0.13
    volumes:
      - redis:/data
    environment:
      - TZ=Asia/Shanghai

volumes:
  redis:
```

> 容器默认时间不是北京时间，增加 TZ=Asia/Shanghai 可以改为北京时间

### 跑起来

在`docker-compose.yml` 文件所在目录，执行：`docker-compose up`就可以跑起来了。
命令参考：https://docs.docker.com/compose/reference/up/

在后台运行只需要加一个 -d 参数`docker-compose up -d`
查看运行状态：`docker-compose ps`
停止运行：`docker-compose stop`
重启：`docker-compose restart`
重启单个服务：`docker-compose restart service-name`
进入容器命令行：`docker-compose exec service-name sh`
查看容器运行log：`docker-compose logs [service-name]`

