---
layout: post   	
catalog: true 	
tags:
    - Docker
---



# 1. 部署mongo

- 数据卷

```
# 存数据
docker volume create yt-mongo_data
# 存配置文件
docker volume create yt-mongo_config
# 存日志
docker volume create yt-mongo_log
```

- 部署命令

```
docker run \
  -d \
  -p 27017:27017 \
  --name yt-mongo \
  --restart=always \
  -v yt-mongo_data:/data/db \
  -v yt-mongo_config:/etc \   (这条命令加上去就会出问题)
  -v yt-mongo_log:/var/log/mongodb \
  mongo
```

- Using a custom MongoDB configuration file（未掌握）

Linux下的默认配置文件位置`/etc/mongod.conf`

```
mongod --config /etc/mongod.conf
```

configuration file content

注：配置文件中只需要规定 log文件的存放位置即可，数据库的存放位置默认为`/data/db`，只需要挂载到数据卷即可

```
systemLog:
   destination: file
   path: "/var/log/mongodb/mongod.log"
   logAppend: true
storage:
   journal:
      enabled: true
processManagement:
   fork: true
net:
   bindIp: 0.0.0.0
   port: 27017
setParameter:
   enableLocalhostAuthBypass: true
security:
   authorization: disable // endable 开启 disable 关闭
```

- Where to Store Data

Linux默认`/data/db`存数据库数据

```
  -v yt-mongo_data:/data/db
```

`/data/configdb` 处理分片集群时需要使用

- 进入mongo容器，using the `mongosh` cli

```
docker exec -it yt-mongo mongosh
```

- 创建数据库用户

```
db.createUser({ user:"root", pwd:"root", roles:["readWrite", "dbAdmin"] })
```

- Setting wiredTiger cache size limits

you will want to set the cache size to something appropriate, taking into account any other processes you may be running in the container which would also utilize memory

eg： you can configure the cache size to use 1.5GB as:

```console
docker run --name some-mongo -d mongo --wiredTigerCacheSizeGB 1.5
```

# 2. 部署redis

- 数据卷

```
# 存放持久化数据
docker volume create yt-redis_data
# 存放日志
docker volume create yt-redis_log
# 存放配置
docker volume create yt-redis_config
```

- 部署命令

```
docker run \
--name yt-redis \
-d \
-p 6379:6379 \
-v yt-redis_config:/usr/local/etc/redis \
-v yt-redis_data:/data \
redis \
redis-server /usr/local/etc/redis/redis.conf --save 180 1 --loglevel warning
```

- start with persistent storage

持久化后的存放地址`/data`

```
-v yt-redis_data:/data
```

- use your own redis.conf

Where `/myredis/conf/` is a local directory containing your `redis.conf` file

```
docker run -v /myredis/conf:/usr/local/etc/redis --name myredis redis redis-server /usr/local/etc/redis/redis.conf
```

- 进入redis容器，使用

```
docker exec -it yt-redis redis-cli
```

# 3. 部署flask

只涉及一个容器不需要使用Docker Compose

在服务器中创建一个code目录

从GitHub上克隆项目到code目录

打开项目文件夹，在该目录下创建文本文件 dockerfile，内容如下
```txt
# 指定基础镜像
FROM python:3.8.10
# 设置工作目录
WORKDIR /app
# 将项目下的requirements.txt文件复制到 /app目录
COPY ./requirements.txt .
# 执行命令pip install --no-cache-dir -r requirements.txt 安装项目依赖
RUN pip install --no-cache-dir -r requirements.txt
# 将Flask 项目复制到容器中的 /app 目录
COPY . .
# 容器向外暴露5000端口
EXPOSE 5000
# 在容器启动时运行 app.py 脚本
CMD [ "python", "app.py" ]
```

在dockerfile所在目录下，使用命令`docker build -t webshell_ids .`构建镜像

到此镜像定制完毕，之后运行该镜像即可启动项目